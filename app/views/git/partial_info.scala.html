@**
* Yobi, Project Hosting SW
*
* Copyright 2013 NAVER Corp.
* http://yobi.io
*
* @author Keesun Baik
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**@
@(project: Project, pull: PullRequest, menuType:String = "overview")

@import utils.JodaDateUtil._
@import utils.TemplateHelper._
@import utils.AccessControl._
@import models.enumeration
@import scala.collection.JavaConversions._

@reviewerCount = @{
    if( project.defaultReviewerCount >= pull.reviewers.size + pull.ongoingReviewers.size ){
        project.defaultReviewerCount
    } else {
        pull.reviewers.size + pull.ongoingReviewers.size
    }
}

@amIReviewer = @{
    val me = UserApp.currentUser()
    if(pull.reviewers.size > 0 && pull.reviewers.contains(me)){
        Html("<span class='i-am-a-reviewer'>" + Html(getMarkedUserAvatar(me, "smallm")) + "</span>")
    } else if(pull.ongoingReviewers.size > 0 && pull.ongoingReviewers.contains(me)){
        Html("<span class='i-am-a-reviewer'>" + Html(getUserAvatar(me, "smallm")) + "</span>")
    }
}
<div class="board-header issue">
    <div class="pull-right mr10 mt10">
        <div class="date" title="@utils.JodaDateUtil.getDateString(pull.created)">
            @agoOrDateString(pull.created)
        </div>
        <span class="badge nm @if(pull.isConflict == true) {badge-issue-conflict} else {badge-issue-@pull.state.state.toLowerCase}">@if(pull.isConflict == true) {@Messages("pullRequest.state.conflict")} else {@Messages("pullRequest.state." + pull.state.state)}</span>
    </div>
    <div class="title">
        <strong class="board-id">#@pull.number</strong> @pull.title
    </div>
</div>

<div class="pull-right review-div">
    @if(project.isUsingReviewerCount){
        <div class="reviewer-area">
            <span class="margin-right-5">
                <strong>@Html(Messages("pullRequest.review.participants", reviewerCount))</strong>
            </span>
        @amIReviewer
        @for(completedReviewer <- pull.reviewers){
            @if(!completedReviewer.equals(UserApp.currentUser())){
                @Html(getMarkedUserAvatar(completedReviewer, "smallm"))
            }
        }
        @if(pull.ongoingReviewers.size > 0){
            @for(reviewer <- pull.ongoingReviewers) {
                @if(!reviewer.equals(UserApp.currentUser())){
                    @Html(getUserAvatar(reviewer, "smallm"))
                }
            }
        }
        @if(pull.toProject.defaultReviewerCount - (pull.reviewers.size + pull.ongoingReviewers.size) > 0){
            @for(idx <- 1 to pull.toProject.defaultReviewerCount - (pull.reviewers.size + pull.ongoingReviewers.size)){
                <span class="blank-avatar" data-toggle="tooltip" title="@Messages("pullRequest.need.more.reviewer")">?</span>
            }
        }
        </div>

        @if(isAllowed(UserApp.currentUser(), pull.asResource(), Operation.ACCEPT) && pull.isOpen){
            @if(pull.doesOngoingReviewBy(UserApp.currentUser())) {
                <a data-request-method="post" class="ybtn margin-bottom-4px review-accept" href="@routes.ReviewApp.review(project.owner, project.name, pull.number)"><i class="yobicon-checkmark"></i>
                @Messages("pullRequest.review")
                </a>
            }
            @if(pull.doesOngoingReviewBy(UserApp.currentUser()) || pull.isReviewedBy(UserApp.currentUser())){
                <a data-request-method="post" class="ybtn ybtn-default margin-bottom-4px" href="@routes.ReviewApp.unreview(project.owner, project.name, pull.number)">
                @Messages("pullRequest.unreview")
                </a>
            } else {
                <a data-request-method="post" class="ybtn margin-bottom-4px" href="@routes.ReviewApp.reviewStart(project.owner, project.name, pull.number)">
                @Messages("pullRequest.review.start")
                </a>
            }
        }
    }

    @if(isAllowed(UserApp.currentUser(), pull.asResource(), Operation.ACCEPT)) {
        @if(pull.isAcceptable){
            <a id="btnAccept" href="@routes.PullRequestApp.accept(project.owner, project.name, pull.number)" data-request-method="post"
               class="ybtn ybtn-success margin-bottom-4px">@Messages("pullRequest.accept")</a>
        } else {
            <button class="ybtn ybtn-disabled margin-bottom-4px" data-toggle="tooltip" data-placement="top"
               title="@pull.getMessageForDisabledAcceptButton">@Messages("pullRequest.accept")</button>
        }
    }
</div>

<ul class="nav nav-tabs nm">
    <li @if(menuType.equals("overview")){class="active"}>
        <a href="@routes.PullRequestApp.pullRequest(project.owner, project.name, pull.number)">@Messages("pullRequest.menu.overview")</a>
    </li>
    <li @if(menuType.equals("changes")){class="active"}>
            <a href="@routes.PullRequestApp.pullRequestChanges(project.owner, project.name, pull.number)">
                @Messages("pullRequest.menu.changes")
        @if(!pull.commentThreads.isEmpty){
            @defining(pull.countCommentThreadsByState(CommentThread.ThreadState.CLOSED)){ countClosed =>
            <i class="ml10 yobicon-post2 vmiddle"></i>
            <div class="upload-progress" style="display: inline-block">
                <div class="bar orange" style="width: @getPercent(countClosed.toDouble, pull.commentThreads.size.toDouble)%;"></div>
            </div>
            <span data-toggle="tooltip" title="@Messages("pullRequest.review.closed") / @Messages("pullRequest.review.total")">
                <span>@countClosed</span>
                <span class="gray-txt">/</span>
                <span class="size total">@pull.commentThreads.size</span>
            </span>
            }
        }
        </a>
    </li>
</ul>

